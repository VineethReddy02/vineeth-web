<!DOCTYPE html>
<html>

    <head>
        <title> Benchmarking your Controllers &amp; Operators at Scale &middot; Vineeth Pothulapati </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.68.3" />




<script src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


<link rel="stylesheet" href="https://vineethweb.com/css/nix.css">



<link rel="shortcut icon" href="/dp.jpeg">



<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">






    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
      <a class="navbar-brand" id="green-terminal" href='https://vineethweb.com/'>
        vineeth@AquaSecurity ~ $
      </a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href='https://vineethweb.com/'>/home/vineeth</a>
        </li>
        
				
				
				<li class="dropdown">
                    
            		<a href="https://vineethweb.com/about">~/about</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://vineethweb.com/talks">~/talks</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://vineethweb.com/projects">~/projects</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://vineethweb.com/post">~/posts</a>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="flex-wrapper">
            <div class="container wrapper">
                <h1><a href="https://vineethweb.com/post/scale-testing-in-k8s/">Benchmarking your Controllers &amp; Operators at Scale</a></h1>
                <span class="post-date">2020-04-19 </span>
                <div class="post-content">
                    <!-- raw HTML omitted -->
<p>The most common problem kubernetes controllers and operators authors face today is to benchmark their tools in large environments with 1000&rsquo;s of workloads running in it. As controllers &amp; operators come with custom logic to perform an action when a specific event occurs in the cluster to achieve the intended state.</p>
<p>Creating 100 node cluster for benchmarking the Kubernetes tools is definitely expensive. Creation, maintainance &amp; deletion is also a tiring job. What if we can create a mock kubelet for scale tests by just running a deployment in your cluster? Yes, This is possible and you can leverage out of this tool in benchmarking the kubernetes tools.</p>
<p>All we need is to simulate loaded environments to perform scale test on our tools. Creating loaded environemnts comes with cost. And we don&rsquo;t want to spend that huge figures in benchmarking our tools.</p>
<p>When I refer to Kubernetes tools, I mean the Kubernetes Controllers, Operators, kubectl plugins, etc.. which interact with api-server for events and perform kubernetes resource scheduling.</p>
<h3 id="mocklethttpsgithubcomvineethreddy02mocklet"><a href="https://github.com/VineethReddy02/mocklet">mocklet</a></h3>
<p>So I will be explaining how to simulate a mocklet that can hold 1000&rsquo;s pods in it&rsquo;s memory and this mock kubelet can be connected to your existing cluster by just running a deployment in your cluster.</p>
<p>Running the below command will create a new mocklet node in your cluster</p>
<pre><code>kubectl create -f https://github.com/VineethReddy02/mocklet/blob/master/k8s-deployment.yaml
</code></pre><p>Now you can notice mocklet is added into your cluster</p>
<pre><code>NAME                                     STATUS   ROLES    AGE     VERSION
gke-gke5684-default-pool-1y5e7l53-kphx   Ready    &lt;none&gt;   4h23m   v1.14.10-gke.27
gke-gke5684-default-pool-1y5e7l53-x5kj   Ready    &lt;none&gt;   4h23m   v1.14.10-gke.27
mocklet                                  Ready    agent    2m32s   v1.15.2-vk-N/A
</code></pre><p>Creating multiple deployments will create multiple mocklets in your cluster to run desired number of kubernetes resources and scheduling resources specific to a mocklet.</p>
<p>Now you can deploy 1000&rsquo;s of pods by providing the node selector value as mocklet and mocklet toleration. This will make sure all the test data you are creating is scheduled on the desired mocklet.</p>
<p>The mocklet project is completely inspired from Virtual Kubelet mock provider. Thanks to the
<strong><a href="https://github.com/virtual-kubelet/virtual-kubelet">Virtual Kubelet community</a>.</strong></p>
<p>The bigger challenge is how do I create 1000&rsquo;s of pods, Deployments, Replicasets, ReplicationControllers, StatefulSets, Jobs and Cronjobs?</p>
<h3 id="k8s-scalerhttpsgithubcomvineethreddy02k8s-scaler"><a href="https://github.com/VineethReddy02/k8s-scaler">k8s-scaler</a></h3>
<p>To create the Kubernetes resources at scale in a single shot. I have implemented tool called <strong>k8s-scaler</strong>. This tool is highly configurable and helps you to create Kubernetes resources which runs pods eventually with higly configurable properties such as number of containers, inclusion &amp; exlusion of namespaces during resource creation, number of Kubernetes resources like deployments, daemonsets, etc&hellip; , number of replicas per Kubernetes controller.</p>
<p>Creating 5000 deployments with replica count as 5 per instance and number of containers per pod as 3 in scale namespace with node-selector &amp; toleration is as simple as</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">./k8s-scaler create deployments --scale <span style="color:#ae81ff">5000</span> --replicas <span style="color:#ae81ff">5</span> --containers <span style="color:#ae81ff">3</span> --namespace scale --node-selector type=mocklet --toleration mocklet.io/provider=mock
</code></pre></div><p><strong>Note:</strong> Using k8s-scaler you can also create/delete namespaces, daemonsets, statefulsets, replicationcontrollers, replicasets, jobs and cronjobs</p>
<p>k8s-scaler also helps you in listing number of kubernetes resources per namespace as shown below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">vineeth@vineeth-Latitude<span style="color:#ae81ff">-7490</span> /bin (master) $ ./k8s-scaler list
NAMESPACE    DEPLOYMENTS  REPLICASETS  DAEMONSETS  STATEFULSETS  PODS  JOBS  CRONJOBS  REPLICATION-CONTROLLERS
test         <span style="color:#ae81ff">3000</span>         <span style="color:#ae81ff">3000</span>         <span style="color:#ae81ff">1000</span>        <span style="color:#ae81ff">500</span>           <span style="color:#ae81ff">7486</span>  <span style="color:#ae81ff">30</span>    <span style="color:#ae81ff">10</span>        <span style="color:#ae81ff">30</span>               
default      <span style="color:#ae81ff">1300</span>         <span style="color:#ae81ff">1300</span>         <span style="color:#ae81ff">456</span>         <span style="color:#ae81ff">250</span>           <span style="color:#ae81ff">5642</span>  <span style="color:#ae81ff">10</span>    <span style="color:#ae81ff">5</span>         <span style="color:#ae81ff">5</span>                  
kube-system  <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">11</span>           <span style="color:#ae81ff">4</span>           <span style="color:#ae81ff">0</span>             <span style="color:#ae81ff">15</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>               
mocklet      <span style="color:#ae81ff">3500</span>         <span style="color:#ae81ff">4000</span>         <span style="color:#ae81ff">1200</span>        <span style="color:#ae81ff">400</span>           <span style="color:#ae81ff">9348</span>  <span style="color:#ae81ff">50</span>    <span style="color:#ae81ff">30</span>        <span style="color:#ae81ff">35</span>     
</code></pre></div><p>Using the <strong>mocklet</strong> and <strong>k8s-scaler</strong> you can create the large environments with ease. Running mocklet will provide the mock kubelet to run the desired number of resources and using k8s-scaler you can create desired number of kubernetes resources by running a single command in any kubernetes cluster.</p>
<p>I hope these tools will help you in scale testing the tools built around kubernetes.</p>
<p>Cheers!</p>

                </div>
                
                <div class="post-comments">
                    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "vineeth" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
                
            </div>
            <footer class="footer text-center">
<p>Copyright &copy; 2020 Vineeth Pothulapati -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

        </div>
    </body>
